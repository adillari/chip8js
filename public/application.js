"use strict";(()=>{var k=h=>{throw TypeError(h)};var I=(h,s,t)=>s.has(h)||k("Cannot "+t);var l=(h,s,t)=>s.has(h)?k("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(h):s.set(h,t);var r=(h,s,t)=>(I(h,s,"access private method"),t);var o,C,c=class{constructor(s){l(this,o);this.SCALE=s,this.ROWS=32,this.COLS=64,this.canvasElement=document.querySelector("canvas"),this.canvasElement.width=this.COLS*this.SCALE,this.canvasElement.height=this.ROWS*this.SCALE,this.canvas=this.canvasElement.getContext("2d"),this.pixelArr=new Array(this.COLS*this.ROWS).fill(0)}togglePixel(s,t){[s,t]=r(this,o,C).call(this,s,t);let i=s+t*this.COLS;return this.pixelArr[i]^=1,!this.pixelArr[i]}clear(){this.pixelArr.fill(!1)}refresh(){this.canvas.clearRect(0,0,this.canvasElement.width,this.canvasElement.height),this.pixelArr.forEach((s,t)=>{if(s){let i=t%this.COLS,x=Math.floor(t/this.COLS);i*=this.SCALE,x*=this.SCALE,this.canvas.fillStyle="#E879F9",this.canvas.fillRect(i,x,this.SCALE,this.SCALE)}})}};o=new WeakSet,C=function(s,t){return s>this.COLS&&(s-=this.COLS),s<0&&(s+=this.COLS),t>this.ROWS&&(t-=this.ROWS),t<0&&(t+=this.ROWS),[s,t]};var b=c;var E=class{constructor(){this.KEYMAP={49:1,50:2,51:3,52:12,81:4,87:5,69:6,82:13,65:7,83:8,68:9,70:14,90:10,88:0,67:11,86:15},this.keysPressed=[],this.onNextKeypress=null,window.addEventListener("keydown",this.onKeyDown.bind(this),!1),window.addEventListener("keyup",this.onKeyUp.bind(this),!1)}isKeyPressed(s){return this.keysPressed[s]}onKeyDown(s){let t=this.KEYMAP[s.which];this.keysPressed[t]=!0,this.onNextKeypress&&t&&(this.onNextKeypress(parseInt(t)),this.onNextKeypress=null)}onKeyUp(s){let t=this.KEYMAP[s.which];this.keysPressed[t]=!1}},P=E;var V=class{constructor(){this.audioContext=new window.AudioContext,this.gain=this.audioContext.createGain(),this.finish=this.audioContext.destination,this.gain.connect(this.finish)}play(s){this.audioContext&&!this.oscillator&&(this.oscillator=this.audioContext.createOscillator(),this.oscillator.frequency.setValueAtTime(s||440,this.audioCtx.currentTime),this.oscillator.type="square",this.oscillator.connect(this.gain),this.oscillator.start())}stop(){this.oscillator&&(this.oscillator.stop(),this.oscillator.disconnect(),this.oscillator=null)}},A=V;var a,w,m,y,u=class{constructor(s,t,i){l(this,a);this.SCREEN=s,this.KEYBOARD=t,this.SPEAKER=i,this.MEMORY=new Uint8Array(4096),this.V=new Uint8Array(16),this.I=0,this.PC=512,this.DT=0,this.ST=0,this.STACK=new Array,this.PAUSED=!1,this.SPEED=6,r(this,a,w).call(this)}cycle(){for(let s=0;s<this.SPEED;s++)if(!this.PAUSED){let t=this.MEMORY[this.PC]<<8|this.MEMORY[this.PC+1];this.executeInstruction(t)}this.PAUSED||r(this,a,m).call(this),r(this,a,y).call(this),this.SCREEN.refresh()}loadProgramIntoRAM(s){s.forEach((t,i)=>{this.MEMORY[512+i]=t})}executeInstruction(s){this.PC+=2;let t=(s&3840)>>8,i=(s&240)>>4;switch(s&61440){case 0:switch(s){case 224:this.SCREEN.clear();break;case 238:this.PC=this.STACK.pop();break}break;case 4096:this.PC=s&4095;break;case 8192:this.STACK.push(this.PC),this.PC=s&4095;break;case 12288:this.V[t]===(s&255)&&(this.PC+=2);break;case 16384:this.V[t]!==(s&255)&&(this.PC+=2);break;case 20480:this.V[t]===this.V[i]&&(this.PC+=2);break;case 24576:this.V[t]=s&255;break;case 28672:this.V[t]+=s&255;break;case 32768:switch(s&15){case 0:this.V[t]=this.V[i];break;case 1:this.V[t]|=this.V[i],this.V[15]=0;break;case 2:this.V[t]&=this.V[i],this.V[15]=0;break;case 3:this.V[t]^=this.V[i],this.V[15]=0;break;case 4:this.V[t]+=this.V[i],this.V[15]=this.V[t]<this.V[i]?1:0;break;case 5:this.V[t]-=this.V[i],this.V[15]=(this.V[t]+this.V[i]&255)<this.V[i]?0:1;break;case 6:let e=this.V[t]&1;this.V[t]>>=1,this.V[15]=e;break;case 7:this.V[t]=this.V[i]-this.V[t],this.V[15]=this.V[t]>this.V[i]?0:1;break;case 14:let f=this.V[t]>>7;this.V[t]<<=1,this.V[15]=f;break}break;case 36864:this.V[t]!==this.V[i]&&(this.PC+=2);break;case 40960:this.I=s&4095;break;case 45056:this.PC=this.V[0]+(s&4095);break;case 49152:let x=Math.floor(Math.random*255);this.V[t]=x&(s&255);break;case 53248:let p=8,K=s&15;for(let e=0;e<K;e++){let f=this.MEMORY[this.I+e];for(let n=0;n<p;n++)f>>7-n&1&&this.SCREEN.togglePixel(this.V[t]+n,this.V[i]+e)&&(this.V[15]=1)}break;case 57344:switch(s&255){case 158:this.KEYBOARD.isKeyPressed(this.V[t])&&(this.PC+=2);break;case 161:this.KEYBOARD.isKeyPressed(this.V[t])||(this.PC+=2);break}break;case 61440:switch(s&255){case 7:this.V[t]=this.DT;break;case 10:this.PAUSED=!0,this.KEYBOARD.onNextKeyPress=e=>{this.V[t]=e,this.PAUSED=!1};break;case 21:this.DT=this.V[t];break;case 24:this.ST=this.V[t];break;case 30:this.I+=this.V[t];break;case 41:this.I=this.V[t]*5;break;case 51:this.MEMORY[this.I]=parseInt(this.V[t]/100),this.MEMORY[this.I+1]=parseInt(this.V[t]%100/10),this.MEMORY[this.I+2]=parseInt(this.V[t]%10);break;case 85:for(let e=0;e<=t;e++)this.MEMORY[this.I+e]=this.V[e];break;case 101:for(let e=0;e<=t;e++)this.V[e]=this.MEMORY[this.I+e];break}break;default:throw new Error("Unknown opcode "+s)}}};a=new WeakSet,w=function(){[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128].forEach((t,i)=>{this.MEMORY[i]=t})},m=function(){this.DT>0&&(this.DT-=1),this.ST>0&&(this.ST-=1)},y=function(){this.soundTimer>0?this.SPEAKER.play(440):this.SPEAKER.stop()};var d=u;var D=new b(15),T=new P,g=new A,M=new d(D,T,g),L=1e3/60,R=Date.now(),S,F;function O(){S=Date.now(),F=S-R,F>L&&(M.cycle(),R=S),requestAnimationFrame(O)}async function Y(h){try{let s=await fetch("roms/"+h);if(!s.ok)return["error",s.statusText];let t=await s.arrayBuffer();return new Uint8Array(t)}catch(s){return["error",s.message]}}window.startMachine=async h=>{let s=await Y(h);s[0]==="error"?alert(s[1]):(M.loadProgramIntoRAM(s),requestAnimationFrame(O))};})();
